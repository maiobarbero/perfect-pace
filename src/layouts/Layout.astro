---
import "../assets/styles/app.css";
import Footer from "../components/Footer.astro"
import Navbar from "../components/Navbar.astro"
import SEO from "../components/SEO.astro"
import CookieBanner from "../components/CookieBanner.jsx"
import ReloadPrompt from "../components/ReloadPrompt.jsx"

interface Props {
    title?: string;
    description?: string;
    image?: string;
}

const { title, description, image } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
        <SEO title={title} description={description} image={image} />

        <link href="https://fonts.googleapis.com" rel="preconnect"/>
        <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;family=Roboto+Mono:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
        <link rel="manifest" href="/perfect-pace/manifest.json" />

        <!-- Google Analytics -->
        <script is:inline>
            // Define dataLayer and the gtag function immediately so other components can use it safely
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            // Make it globally available
            window.gtag = gtag;

            // Function to load the external GA script
            function loadGoogleAnalytics() {
                if (window.ga_loaded) return;
                window.ga_loaded = true;

                const script = document.createElement('script');
                script.src = "https://www.googletagmanager.com/gtag/js?id=G-LMTDVWZGR4";
                script.async = true;
                document.head.appendChild(script);

                gtag('js', new Date());
                gtag('config', 'G-LMTDVWZGR4');
            }

            // Check for existing consent
            try {
                const cookieConsent = localStorage.getItem('cookie_consent');
                if (cookieConsent) {
                    const parsed = JSON.parse(cookieConsent);
                    if (parsed.analytics) {
                        loadGoogleAnalytics();
                    }
                }
            } catch (e) {
                console.error("Error parsing cookie consent", e);
            }

            // Listen for consent updates
            window.addEventListener('cookie_consent_updated', (e) => {
                if (e.detail && e.detail.analytics) {
                    loadGoogleAnalytics();
                }
            });

            // Track PWA Installation
            window.addEventListener('appinstalled', () => {
                gtag('event', 'pwa_install', {
                    'event_category': 'pwa',
                    'event_label': 'install',
                    'value': 1
                });
            });
        </script>

        <script is:inline>
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
              document.documentElement.classList.add('dark')
            } else {
              document.documentElement.classList.remove('dark')
            }
        </script>
	</head>
    <body class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-100 font-display transition-colors duration-300 min-h-screen flex flex-col">
        <Navbar />
        <main class="flex-grow container mx-auto px-4 pb-12 max-w-5xl space-y-8">
		    <slot />
        </main>
        <Footer />

        <div class="fixed bottom-4 right-4 no-print">
            <button class="bg-surface-dark dark:bg-surface-light text-white dark:text-slate-900 p-3 rounded-full shadow-lg transition-transform hover:scale-110" id="theme-toggle" aria-label="Toggle Dark Mode">
            <span class="material-icons-round dark:hidden">dark_mode</span>
            <span class="material-icons-round hidden dark:block">light_mode</span>
            </button>
        </div>
        <script is:inline>
            document.getElementById('theme-toggle').addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                }
            });
        </script>
        <CookieBanner client:load />
        <ReloadPrompt client:load />
	</body>
</html>
